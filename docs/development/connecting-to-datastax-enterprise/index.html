<!doctype html>
<html>
<head>
  <title>KillrVideo - Connecting to DataStax Enterprise</title>
  <link href="/assets/css/bundle.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/assets/images/killrvideo-icon.png"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  
  <header>
    <nav class="nav">
      <div class="container">
        <div class="nav-left">
          <a href="/" class="nav-item">
            <img src="/assets/images/killrvideo.png" alt="KillrVideo logo" />
          </a>
        </div>

        <!-- Nav Toggle on mobile -->
        <span class="nav-toggle">
          <span></span>
          <span></span>
          <span></span>
        </span>

        <div class="nav-right nav-menu">
          <span class="nav-item">
            <a href="/getting-started/" class="button is-primary">
              <i class="fa fa-code fa-fw"></i> Get Started
            </a>
          </span>
          <a href="/docs/" class="nav-item">
            Docs
          </a>
          <a href="/support/" class="nav-item">
            Support
          </a>
          <a href="https://github.com/KillrVideo" target="_blank" class="nav-item">
            <i class="fa fa-github fa-2x"></i>
          </a>
        </div>
      </div>
    </nav>
  </header>

  
  
<section class="section">
  <div class="container">
    <div class="columns">
      <article class="column is-8-tablet is-9-widescreen content">
        <h1 id="connecting-to-datastax-enterprise">Connecting to DataStax Enterprise</h1>
<p>These microservices are part of a reference application for Cassandra and DSE, so you&#39;ll 
obviously be connecting to a DSE node. You should already have your Docker environment setup
and running after completeing the <a href="/docs/development/setup-docker-environment/">Setup Docker Environment</a> step. Part of that
environment includes a running DSE node. So how do you get the IP address and port that you
need to connect?</p>
<h2 id="understanding-registrator">Understanding Registrator</h2>
<p>This is where our service discovery via <a href="https://github.com/coreos/etcd" target="_blank">etcd</a> comes in. Part of the Docker environment
you created also contains one node of etcd, as well as a container running <a href="https://github.com/gliderlabs/registrator" target="_blank">Registrator</a>.
Registrator will automatically register any containers that startup in the Docker environment 
with the node of etcd (so that you can discover where they are running). So how does
Registrator know what service name to use when registering a service with etcd? Let&#39;s take a
look at a part of the <code>docker-compose.yaml</code> where our DSE service is defined:</p>
<pre><code class="hljs">  <span class="hljs-comment"># ... other services snipped ...</span>

  <span class="hljs-comment"># DataStax Enterprise</span>
<span class="hljs-attr">  dse:</span>
<span class="hljs-attr">    image:</span> <span class="hljs-string">killrvideo/killrvideo-dse:1.0.0</span>
<span class="hljs-attr">    ports:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">"9042:9042"</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">"8983:8983"</span>
<span class="hljs-attr">    cap_add:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">IPC_LOCK</span>
<span class="hljs-attr">    ulimits:</span>
<span class="hljs-attr">      memlock:</span> <span class="hljs-bullet">-1</span>
<span class="hljs-attr">    environment:</span>
<span class="hljs-attr">      SERVICE_9042_NAME:</span> <span class="hljs-string">cassandra</span>
<span class="hljs-attr">      SERVICE_8983_NAME:</span> <span class="hljs-string">dse-search</span></pre></code><p>The environment variable <code>SERVICE_9042_NAME</code> is defined in that <code>.yaml</code> to tell Registrator
to register the service listening on port <code>9042</code> (the default port for executing CQL in
Cassandra) as the <code>cassandra</code> service. If we had not explicitly set the service name via that
environment variable, Registrator would have used its <a href="http://gliderlabs.com/registrator/latest/user/services/#service-name" target="_blank">default behavior</a>
for service names when naming the service and registering it with etcd. The same is true for
the <code>dse-search</code> service running on port <code>8983</code>.</p>
<p>Registrator is configured to register all containers in etcd as keys under <code>/killrvideo/services</code>.
You&#39;ll want to keep that in mind when querying for service locations as described below.</p>
<h2 id="connecting-to-etcd">Connecting to etcd</h2>
<p>Now that we know we can get the host and port for our DSE node by looking up the <code>cassandra</code>
service in etcd, how do we connect to etcd itself? This is where our <code>.env</code> file that was
written as part of the Docker setup comes in handy. That file contains the IP addresses of
both your Host (i.e. dev laptop) and Docker where containers are running. Our microservices 
code can read the environment values from the <code>.env</code> file and use the <code>KILLRVIDEO_DOCKER_IP</code> 
variable as the IP address to talk to etcd. By default, etcd listens on port <code>2379</code>.</p>
<h2 id="querying-etcd-to-find-services">Querying etcd to Find Services</h2>
<p>The <a href="https://github.com/coreos/etcd/blob/master/Documentation/v2/api.md" target="_blank">v2 API of etcd</a> is exposed via simple HTTP endpoints, so we can use any
client capable of making HTTP requests to query etcd. For example, we can get the location of
the <code>cassandra</code> service by doing a <code>GET</code> request to:</p>
<pre><code>http://${ETCD_IP_ADDRESS}:2379/v2/keys/killrvideo/services/cassandra</code></pre><p>You could, of course, similarly lookup the <code>dse-search</code> service by doing a <code>GET</code> request to:</p>
<pre><code>http://${ETCD_IP_ADDRESS}:2379/v2/keys/killrvideo/services/dse-search</code></pre><p>Many programming languages also offer specific etcd client libraries that provide a nicer
interface for doing operations against etcd. You may want to investigate using something like
that instead of doing manual HTTP requests. Just remember if using a client library that
you&#39;re doing operations against a v2 node, so configure your client accordingly. </p>
<h2 id="making-sure-dse-is-ready">Making sure DSE is Ready</h2>
<p>Once we have the IP address and port for the <code>cassandra</code> service, we can then go about
configuring the driver to connect to our DSE cluster (i.e. a single node running in Docker).
One thing to keep in mind when writing the code that sets up and initially connects to the
cluster is that DSE takes time to start up when it&#39;s launched. This is especially true for a
brand new node that is starting for the first time.</p>
<p>So, when writing the code that initially connects to DSE, be sure to add some retry logic
that retries the intial connection. In other microservice implementations, we&#39;ve found that
<strong>90-120 seconds</strong> is usually enough time for it to start, so we built in retries for up to
that time period before exiting with an error.</p>
<h2 id="the-cql-schema-and-solr-configuration">The CQL Schema and Solr Configuration</h2>
<p>The <a href="https://github.com/KillrVideo/killrvideo-dse-docker" target="_blank">DSE Docker image</a> defined in the common <code>docker-compose.yaml</code> file that
we looked at above contains code that will bootstrap the CQL schema and Solr configuration 
for you the first time it&#39;s started. Since both ports <code>9042</code> and <code>8983</code> are exposed, it&#39;s 
possible to connect to DSE from your laptop if you want. For example, you could use DevCenter
or <code>cqlsh</code> to connect and explore the CQL schema. Or you could access the Solr Admin UI 
(included in DSE search) to take a look at the Solr resources that were created.</p>

      </article>
      <div class="column is-4-tablet is-3-widescreen">
        <nav class="docs panel">
          <div class="panel-heading">
            <span class="icon">
              <i class="fa fa-wrench"></i>
            </span>
            Advanced
          </div>

          

          
          
          

          <div class="panel-block">
            <a href="/docs/development/implementers-cheatsheet/">Microservice Implementer&#39;s Cheatsheet</a>

            
            
          </div>

          

          
          
          

          <div class="panel-block">
            <a href="/docs/development/setup-git-repo/">Setting up the Git Repo</a>

            
            
          </div>

          

          
          
          

          <div class="panel-block">
            <a href="/docs/development/setup-docker-environment/">Setting up the Docker Environment</a>

            
            
          </div>

          

          
          
          

          <div class="panel-block">
            <a href="/docs/development/generate-service-code/">Generating Service Code</a>

            
            
          </div>

          

          
          
          
            
          

          <div class="panel-block is-active">
            <a href="/docs/development/connecting-to-datastax-enterprise/">Connecting to DataStax Enterprise</a>

            
            
            <ul class="headings-list links-list">
            
              <li>
                <a href="/docs/development/connecting-to-datastax-enterprise/#understanding-registrator">Understanding Registrator</a>
              </li>
            
              <li>
                <a href="/docs/development/connecting-to-datastax-enterprise/#connecting-to-etcd">Connecting to etcd</a>
              </li>
            
              <li>
                <a href="/docs/development/connecting-to-datastax-enterprise/#querying-etcd-to-find-services">Querying etcd to Find Services</a>
              </li>
            
              <li>
                <a href="/docs/development/connecting-to-datastax-enterprise/#making-sure-dse-is-ready">Making sure DSE is Ready</a>
              </li>
            
              <li>
                <a href="/docs/development/connecting-to-datastax-enterprise/#the-cql-schema-and-solr-configuration">The CQL Schema and Solr Configuration</a>
              </li>
            
            </ul>
            
          </div>

          

          
          
          

          <div class="panel-block">
            <a href="/docs/development/implement-services/">Implementing the Services</a>

            
            
          </div>

          

          
          
          

          <div class="panel-block">
            <a href="/docs/development/pub-sub-messaging/">Adding Pub-Sub Messaging</a>

            
            
          </div>

          

          
          
          

          <div class="panel-block">
            <a href="/docs/development/functional-specs/">Microservice Functional Specifications</a>

            
            
          </div>

          

          
          
          

          <div class="panel-block">
            <a href="/docs/development/register-with-etcd/">Registering Services with etcd</a>

            
            
          </div>

          

          
          
          

          <div class="panel-block">
            <a href="/docs/development/using-the-web-tier/">Using the Web Tier</a>

            
            
          </div>

          

          
          
          

          <div class="panel-block">
            <a href="/docs/development/generating-sample-data/">Generating Sample Data</a>

            
            
          </div>

          
        
        </nav>
      </div>
    </div>
  </div>
</section>


  
  <footer class="footer">
    <div class="container level">
      <div class="level-left">
        <div class="level-item">
          <p>
            <strong>KillrVideo</strong> is open source and available under an 
            <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache 2.0</a> license.
          <p>
          <p>
            <small>Site version <a href="https://github.com/KillrVideo/killrvideo.github.io/commit/0821e5eb48f8b2b94e5300464f2c57816b662d8d" target="_blank">0821e5e</a></small>
          </p>
        </div>
      </div>
      <div class="level-right">
        <div class="level-right">
          <a class="button level-item" href="https://github.com/KillrVideo/killrvideo.github.io/tree/source/src/site/docs/development/connecting-to-datastax-enterprise.md" target="_blank">
            <i class="fa fa-github fa-fw"></i>Improve this page
          </a>
        </div>
      </div>
    </div>
  </footer>
  
  <script type="text/javascript" src="/assets/js/bundle.js"></script>

  
  
<script type="text/javascript">
  // Make doc navigation sticky once window is scrolled past 100px
  KillrVideo.sticky('nav.docs', 100, 20);
</script>

</body>
</html>